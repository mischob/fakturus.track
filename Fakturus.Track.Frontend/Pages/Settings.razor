@page "/settings"
@using Blazored.Toast.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ISettingsApiClient SettingsApiClient
@inject ISchoolHolidayApiClient SchoolHolidayApiClient
@inject IToastService ToastService

<PageTitle>Einstellungen - Time Tracker</PageTitle>

<div class="py-6 space-y-6">
    <h1 class="text-3xl font-bold text-gray-900">Einstellungen</h1>

    @if (_isLoading)
    {
        <div class="text-center py-12">
            <p class="text-gray-600">Lade Einstellungen...</p>
        </div>
    }
    else if (_settings != null)
    {
        <div class="card">
            <h2 class="text-xl font-semibold mb-6">Arbeitszeit & Urlaub</h2>

            <div class="space-y-6">
                <!-- Vacation Days Per Year -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Urlaubstage pro Jahr
                    </label>
                    <input type="number"
                           @bind="_settings.VacationDaysPerYear"
                           min="1"
                           max="365"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="z.B. 30"/>
                    <p class="mt-1 text-sm text-gray-500">
                        Anzahl der Urlaubstage, die Ihnen pro Jahr zur Verfügung stehen
                    </p>
                </div>

                <!-- Work Hours Per Week -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Arbeitsstunden pro Woche
                    </label>
                    <input type="number"
                           @bind="_settings.WorkHoursPerWeek"
                           min="1"
                           max="168"
                           step="0.5"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="z.B. 40"/>
                    <p class="mt-1 text-sm text-gray-500">
                        Ihre wöchentliche Sollarbeitszeit (z.B. 40 für eine Vollzeitstelle)
                    </p>
                </div>

                <!-- Work Days Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Arbeitstage
                    </label>
                    <p class="text-sm text-gray-500 mb-3">
                        Wählen Sie die Tage, an denen Sie typischerweise arbeiten:
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                        @for (var i = 0; i < 7; i++)
                        {
                            var index = i; // Capture for lambda
                            var dayName = GetDayName(index);
                            var isSelected = GetDaySelection(index);

                            <label class="flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer transition-colors @(isSelected ? "bg-blue-50 border-blue-500" : "bg-white border-gray-300 hover:border-gray-400")">
                                <input type="checkbox"
                                       checked="@isSelected"
                                       @onchange="@(() => ToggleWorkDay(index))"
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/>
                                <span class="text-sm font-medium @(isSelected ? "text-blue-900" : "text-gray-700")">@dayName</span>
                            </label>
                        }
                    </div>
                </div>

                <!-- Bundesland Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Bundesland
                    </label>
                    <select @bind="_settings.Bundesland"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="BW">Baden-Württemberg</option>
                        <option value="BY">Bayern</option>
                        <option value="BE">Berlin</option>
                        <option value="BB">Brandenburg</option>
                        <option value="HB">Bremen</option>
                        <option value="HH">Hamburg</option>
                        <option value="HE">Hessen</option>
                        <option value="MV">Mecklenburg-Vorpommern</option>
                        <option value="NI">Niedersachsen</option>
                        <option value="NW">Nordrhein-Westfalen</option>
                        <option value="RP">Rheinland-Pfalz</option>
                        <option value="SL">Saarland</option>
                        <option value="SN">Sachsen</option>
                        <option value="ST">Sachsen-Anhalt</option>
                        <option value="SH">Schleswig-Holstein</option>
                        <option value="TH">Thüringen</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">
                        Ihr Bundesland für die Berechnung von Feiertagen
                    </p>
                </div>

                <!-- School Holiday Periods -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Schulferien
                    </label>
                    <p class="text-sm text-gray-500 mb-3">
                        Definieren Sie Schulferienzeiten für die Berechnung nicht gearbeiteter Stunden
                    </p>

                    @if (_schoolHolidayPeriods.Any())
                    {
                        <div class="space-y-2 mb-3">
                            @foreach (var period in _schoolHolidayPeriods.OrderBy(p => p.StartDate))
                            {
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <span class="font-medium">@period.Name</span>
                                        <span class="text-sm text-gray-600 ml-2">
                                            (@period.StartDate.ToString("dd.MM.yyyy") - @period.EndDate.ToString("dd.MM.yyyy"))
                                        </span>
                                    </div>
                                    <button @onclick="() => DeleteSchoolHolidayPeriod(period.Id)"
                                            class="text-red-600 hover:text-red-800 p-2 rounded hover:bg-red-50">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            }
                        </div>
                    }

                    <div class="border border-gray-300 rounded-lg p-4 space-y-3">
                        <input type="text"
                               @bind="_newPeriodName"
                               placeholder="Name (z.B. Sommerferien 2025)"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Von</label>
                                <input type="date"
                                       value="@_newPeriodStart"
                                       @onchange="@((ChangeEventArgs e) => _newPeriodStart = e.Value?.ToString() ?? string.Empty)"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Bis</label>
                                <input type="date"
                                       value="@_newPeriodEnd"
                                       @onchange="@((ChangeEventArgs e) => _newPeriodEnd = e.Value?.ToString() ?? string.Empty)"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
                            </div>
                        </div>
                        <button @onclick="AddSchoolHolidayPeriod"
                                disabled="@_isAddingPeriod"
                                class="btn-secondary w-full @(_isAddingPeriod ? "opacity-50 cursor-not-allowed" : "")">
                            @if (_isAddingPeriod)
                            {
                                <span>Hinzufügen...</span>
                            }
                            else
                            {
                                <span>Schulferienzeit hinzufügen</span>
                            }
                        </button>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="flex gap-3">
                    <button @onclick="HandleSave"
                            disabled="@_isSaving"
                            class="btn-primary @(_isSaving ? "opacity-50 cursor-not-allowed" : "")">
                        @if (_isSaving)
                        {
                            <span>Speichern...</span>
                        }
                        else
                        {
                            <span>Einstellungen speichern</span>
                        }
                    </button>

                    <button @onclick="HandleReset"
                            disabled="@_isSaving"
                            class="btn-secondary">
                        Zurücksetzen
                    </button>
                </div>
            </div>
        </div>

        <!-- Information Card -->
        <div class="card bg-blue-50 border border-blue-200">
            <div class="flex gap-3">
                <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-semibold text-blue-900 mb-2">Überstunden-Berechnung</h3>
                    <p class="text-sm text-blue-800">
                        Überstunden werden auf Wochenbasis berechnet. Die erwarteten Arbeitsstunden pro Woche werden auf die ausgewählten Arbeitstage verteilt.
                        Wochenenden, Urlaubstage und Feiertage werden als gearbeitete Zeit gezählt. Wenn Sie mehr als die erwarteten Stunden arbeiten,
                        werden diese als Überstunden gezählt.
                    </p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card text-center py-12">
            <p class="text-gray-600">Fehler beim Laden der Einstellungen</p>
        </div>
    }
</div>

@code {
    private UserSettingsModel? _settings;
    private UserSettingsModel? _originalSettings;
    private bool _isLoading = true;
    private bool _isSaving;
    private List<SchoolHolidayPeriodModel> _schoolHolidayPeriods = new();
    private string _newPeriodName = string.Empty;
    private string _newPeriodStart = string.Empty;
    private string _newPeriodEnd = string.Empty;
    private bool _isAddingPeriod;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
        await LoadSchoolHolidayPeriodsAsync();
    }

    private async Task LoadSettingsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _settings = await SettingsApiClient.GetUserSettingsAsync();
            _originalSettings = new UserSettingsModel
            {
                VacationDaysPerYear = _settings.VacationDaysPerYear,
                WorkHoursPerWeek = _settings.WorkHoursPerWeek,
                WorkDays = _settings.WorkDays,
                Bundesland = _settings.Bundesland
            };
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Laden der Einstellungen: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSave()
    {
        if (_settings == null) return;

        // Validate
        if (_settings.VacationDaysPerYear < 1 || _settings.VacationDaysPerYear > 365)
        {
            ToastService.ShowError("Urlaubstage müssen zwischen 1 und 365 liegen");
            return;
        }

        if (_settings.WorkHoursPerWeek <= 0 || _settings.WorkHoursPerWeek > 168)
        {
            ToastService.ShowError("Arbeitsstunden pro Woche müssen zwischen 0 und 168 liegen");
            return;
        }

        if (_settings.WorkDays <= 0)
        {
            ToastService.ShowError("Mindestens ein Arbeitstag muss ausgewählt sein");
            return;
        }

        _isSaving = true;
        StateHasChanged();

        try
        {
            var request = new UpdateUserSettingsRequest
            {
                VacationDaysPerYear = _settings.VacationDaysPerYear,
                WorkHoursPerWeek = _settings.WorkHoursPerWeek,
                WorkDays = _settings.WorkDays,
                Bundesland = _settings.Bundesland
            };

            _settings = await SettingsApiClient.UpdateUserSettingsAsync(request);

            _originalSettings = new UserSettingsModel
            {
                VacationDaysPerYear = _settings.VacationDaysPerYear,
                WorkHoursPerWeek = _settings.WorkHoursPerWeek,
                WorkDays = _settings.WorkDays,
                Bundesland = _settings.Bundesland
            };

            ToastService.ShowSuccess("Einstellungen gespeichert");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Speichern: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void HandleReset()
    {
        if (_originalSettings != null && _settings != null)
        {
            _settings.VacationDaysPerYear = _originalSettings.VacationDaysPerYear;
            _settings.WorkHoursPerWeek = _originalSettings.WorkHoursPerWeek;
            _settings.WorkDays = _originalSettings.WorkDays;
            _settings.Bundesland = _originalSettings.Bundesland;
            StateHasChanged();
            ToastService.ShowInfo("Änderungen zurückgesetzt");
        }
    }

    // Helper methods for workdays bitmask
    private string GetDayName(int dayIndex)
    {
        return dayIndex switch
        {
            0 => "Mo",
            1 => "Di",
            2 => "Mi",
            3 => "Do",
            4 => "Fr",
            5 => "Sa",
            6 => "So",
            _ => ""
        };
    }

    private bool GetDaySelection(int dayIndex)
    {
        if (_settings == null) return false;
        return (_settings.WorkDays & (1 << dayIndex)) != 0;
    }

    private void ToggleWorkDay(int dayIndex)
    {
        if (_settings == null) return;

        var mask = 1 << dayIndex;
        if ((_settings.WorkDays & mask) != 0)
        {
            // Day is selected, unselect it
            _settings.WorkDays &= ~mask;
        }
        else
        {
            // Day is not selected, select it
            _settings.WorkDays |= mask;
        }

        StateHasChanged();
    }

    // School Holiday Period methods
    private async Task LoadSchoolHolidayPeriodsAsync()
    {
        try
        {
            _schoolHolidayPeriods = await SchoolHolidayApiClient.GetSchoolHolidayPeriodsAsync();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Laden der Schulferien: {ex.Message}");
        }
    }

    private async Task AddSchoolHolidayPeriod()
    {
        if (string.IsNullOrWhiteSpace(_newPeriodName))
        {
            ToastService.ShowError("Bitte geben Sie einen Namen ein");
            return;
        }

        if (string.IsNullOrWhiteSpace(_newPeriodStart) || string.IsNullOrWhiteSpace(_newPeriodEnd))
        {
            ToastService.ShowError("Bitte wählen Sie Start- und Enddatum");
            return;
        }

        if (!DateOnly.TryParse(_newPeriodStart, out var startDate) || !DateOnly.TryParse(_newPeriodEnd, out var endDate))
        {
            ToastService.ShowError("Ungültiges Datumsformat");
            return;
        }

        if (endDate < startDate)
        {
            ToastService.ShowError("Enddatum muss nach dem Startdatum liegen");
            return;
        }

        _isAddingPeriod = true;
        StateHasChanged();

        try
        {
            var request = new CreateSchoolHolidayPeriodRequest
            {
                Name = _newPeriodName,
                StartDate = startDate,
                EndDate = endDate
            };

            await SchoolHolidayApiClient.CreateSchoolHolidayPeriodAsync(request);
            await LoadSchoolHolidayPeriodsAsync();

            // Clear form
            _newPeriodName = string.Empty;
            _newPeriodStart = string.Empty;
            _newPeriodEnd = string.Empty;

            ToastService.ShowSuccess("Schulferienzeit hinzugefügt");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Hinzufügen: {ex.Message}");
        }
        finally
        {
            _isAddingPeriod = false;
            StateHasChanged();
        }
    }

    private async Task DeleteSchoolHolidayPeriod(Guid id)
    {
        try
        {
            await SchoolHolidayApiClient.DeleteSchoolHolidayPeriodAsync(id);
            await LoadSchoolHolidayPeriodsAsync();
            ToastService.ShowSuccess("Schulferienzeit gelöscht");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Löschen: {ex.Message}");
        }
    }

}