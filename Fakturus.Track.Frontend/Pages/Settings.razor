@page "/settings"
@attribute [Authorize]
@using Blazored.Toast.Services
@using Microsoft.AspNetCore.Authorization
@using Fakturus.Track.Frontend.Models
@inject ISettingsApiClient SettingsApiClient
@inject IToastService ToastService

<PageTitle>Einstellungen - Time Tracker</PageTitle>

<div class="py-6 space-y-6">
    <h1 class="text-3xl font-bold text-gray-900">Einstellungen</h1>

    @if (_isLoading)
    {
        <div class="text-center py-12">
            <p class="text-gray-600">Lade Einstellungen...</p>
        </div>
    }
    else if (_settings != null)
    {
        <div class="card">
            <h2 class="text-xl font-semibold mb-6">Arbeitszeit & Urlaub</h2>

            <div class="space-y-6">
                <!-- Vacation Days Per Year -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Urlaubstage pro Jahr
                    </label>
                    <input type="number"
                           @bind="_settings.VacationDaysPerYear"
                           min="1"
                           max="365"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="z.B. 30"/>
                    <p class="mt-1 text-sm text-gray-500">
                        Anzahl der Urlaubstage, die Ihnen pro Jahr zur Verfügung stehen
                    </p>
                </div>

                <!-- Work Hours Per Week -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Arbeitsstunden pro Woche
                    </label>
                    <input type="number"
                           @bind="_settings.WorkHoursPerWeek"
                           min="1"
                           max="168"
                           step="0.5"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="z.B. 40"/>
                    <p class="mt-1 text-sm text-gray-500">
                        Ihre wöchentliche Sollarbeitszeit (z.B. 40 für eine Vollzeitstelle)
                    </p>
                </div>

                <!-- Work Days Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Arbeitstage
                    </label>
                    <p class="text-sm text-gray-500 mb-3">
                        Wählen Sie die Tage, an denen Sie typischerweise arbeiten:
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                        @for (int i = 0; i < 7; i++)
                        {
                            var index = i; // Capture for lambda
                            var dayName = GetDayName(index);
                            var isSelected = GetDaySelection(index);
                            
                            <label class="flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer transition-colors @(isSelected ? "bg-blue-50 border-blue-500" : "bg-white border-gray-300 hover:border-gray-400")">
                                <input type="checkbox"
                                       checked="@isSelected"
                                       @onchange="@(() => ToggleWorkDay(index))"
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/>
                                <span class="text-sm font-medium @(isSelected ? "text-blue-900" : "text-gray-700")">@dayName</span>
                            </label>
                        }
                    </div>
                </div>

                <!-- Bundesland Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Bundesland
                    </label>
                    <select @bind="_settings.Bundesland"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="BW">Baden-Württemberg</option>
                        <option value="BY">Bayern</option>
                        <option value="BE">Berlin</option>
                        <option value="BB">Brandenburg</option>
                        <option value="HB">Bremen</option>
                        <option value="HH">Hamburg</option>
                        <option value="HE">Hessen</option>
                        <option value="MV">Mecklenburg-Vorpommern</option>
                        <option value="NI">Niedersachsen</option>
                        <option value="NW">Nordrhein-Westfalen</option>
                        <option value="RP">Rheinland-Pfalz</option>
                        <option value="SL">Saarland</option>
                        <option value="SN">Sachsen</option>
                        <option value="ST">Sachsen-Anhalt</option>
                        <option value="SH">Schleswig-Holstein</option>
                        <option value="TH">Thüringen</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">
                        Ihr Bundesland für die Berechnung von Feiertagen
                    </p>
                </div>

                <!-- Save Button -->
                <div class="flex gap-3">
                    <button @onclick="HandleSave"
                            disabled="@_isSaving"
                            class="btn-primary @(_isSaving ? "opacity-50 cursor-not-allowed" : "")">
                        @if (_isSaving)
                        {
                            <span>Speichern...</span>
                        }
                        else
                        {
                            <span>Einstellungen speichern</span>
                        }
                    </button>

                    <button @onclick="HandleReset"
                            disabled="@_isSaving"
                            class="btn-secondary">
                        Zurücksetzen
                    </button>
                </div>
            </div>
        </div>

        <!-- Information Card -->
        <div class="card bg-blue-50 border border-blue-200">
            <div class="flex gap-3">
                <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-semibold text-blue-900 mb-2">Überstunden-Berechnung</h3>
                    <p class="text-sm text-blue-800">
                        Überstunden werden auf Wochenbasis berechnet. Die erwarteten Arbeitsstunden pro Woche werden auf die ausgewählten Arbeitstage verteilt. 
                        Wochenenden, Urlaubstage und Feiertage werden als gearbeitete Zeit gezählt. Wenn Sie mehr als die erwarteten Stunden arbeiten, 
                        werden diese als Überstunden gezählt.
                    </p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card text-center py-12">
            <p class="text-gray-600">Fehler beim Laden der Einstellungen</p>
        </div>
    }
</div>

@code {
    private UserSettingsModel? _settings;
    private UserSettingsModel? _originalSettings;
    private bool _isLoading = true;
    private bool _isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
    }

    private async Task LoadSettingsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _settings = await SettingsApiClient.GetUserSettingsAsync();
            _originalSettings = new UserSettingsModel
            {
                VacationDaysPerYear = _settings.VacationDaysPerYear,
                WorkHoursPerWeek = _settings.WorkHoursPerWeek,
                WorkDays = _settings.WorkDays,
                Bundesland = _settings.Bundesland
            };
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Laden der Einstellungen: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSave()
    {
        if (_settings == null) return;

        // Validate
        if (_settings.VacationDaysPerYear < 1 || _settings.VacationDaysPerYear > 365)
        {
            ToastService.ShowError("Urlaubstage müssen zwischen 1 und 365 liegen");
            return;
        }

        if (_settings.WorkHoursPerWeek <= 0 || _settings.WorkHoursPerWeek > 168)
        {
            ToastService.ShowError("Arbeitsstunden pro Woche müssen zwischen 0 und 168 liegen");
            return;
        }

        if (_settings.WorkDays <= 0)
        {
            ToastService.ShowError("Mindestens ein Arbeitstag muss ausgewählt sein");
            return;
        }

        _isSaving = true;
        StateHasChanged();

        try
        {
            var request = new UpdateUserSettingsRequest
            {
                VacationDaysPerYear = _settings.VacationDaysPerYear,
                WorkHoursPerWeek = _settings.WorkHoursPerWeek,
                WorkDays = _settings.WorkDays,
                Bundesland = _settings.Bundesland
            };

            _settings = await SettingsApiClient.UpdateUserSettingsAsync(request);
            
            _originalSettings = new UserSettingsModel
            {
                VacationDaysPerYear = _settings.VacationDaysPerYear,
                WorkHoursPerWeek = _settings.WorkHoursPerWeek,
                WorkDays = _settings.WorkDays,
                Bundesland = _settings.Bundesland
            };

            ToastService.ShowSuccess("Einstellungen gespeichert");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Speichern: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void HandleReset()
    {
        if (_originalSettings != null && _settings != null)
        {
            _settings.VacationDaysPerYear = _originalSettings.VacationDaysPerYear;
            _settings.WorkHoursPerWeek = _originalSettings.WorkHoursPerWeek;
            _settings.WorkDays = _originalSettings.WorkDays;
            _settings.Bundesland = _originalSettings.Bundesland;
            StateHasChanged();
            ToastService.ShowInfo("Änderungen zurückgesetzt");
        }
    }

    // Helper methods for workdays bitmask
    private string GetDayName(int dayIndex) => dayIndex switch
    {
        0 => "Mo",
        1 => "Di",
        2 => "Mi",
        3 => "Do",
        4 => "Fr",
        5 => "Sa",
        6 => "So",
        _ => ""
    };

    private bool GetDaySelection(int dayIndex)
    {
        if (_settings == null) return false;
        return (_settings.WorkDays & (1 << dayIndex)) != 0;
    }

    private void ToggleWorkDay(int dayIndex)
    {
        if (_settings == null) return;
        
        int mask = 1 << dayIndex;
        if ((_settings.WorkDays & mask) != 0)
        {
            // Day is selected, unselect it
            _settings.WorkDays &= ~mask;
        }
        else
        {
            // Day is not selected, select it
            _settings.WorkDays |= mask;
        }
        StateHasChanged();
    }
}

