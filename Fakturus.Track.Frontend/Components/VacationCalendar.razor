@using Fakturus.Track.Frontend.Models

<div class="card">
    <div class="flex justify-between items-center mb-4">
        <button @onclick="PreviousMonth" class="p-2 hover:bg-gray-100 rounded">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>
        <h3 class="text-lg font-semibold">@CurrentMonth.ToString("MMMM yyyy")</h3>
        <button @onclick="NextMonth" class="p-2 hover:bg-gray-100 rounded">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </div>

    <!-- Day headers -->
    <div class="grid grid-cols-7 gap-1 mb-2">
        <div class="text-center text-xs font-semibold text-gray-600 py-2">Mo</div>
        <div class="text-center text-xs font-semibold text-gray-600 py-2">Di</div>
        <div class="text-center text-xs font-semibold text-gray-600 py-2">Mi</div>
        <div class="text-center text-xs font-semibold text-gray-600 py-2">Do</div>
        <div class="text-center text-xs font-semibold text-gray-600 py-2">Fr</div>
        <div class="text-center text-xs font-semibold text-gray-600 py-2">Sa</div>
        <div class="text-center text-xs font-semibold text-gray-600 py-2">So</div>
    </div>

    <!-- Calendar days -->
    <div class="grid grid-cols-7 gap-1">
        @foreach (var day in CalendarDays)
        {
            <button @onclick="() => ToggleDay(day)"
                    disabled="@(!day.IsCurrentMonth)"
                    class="@GetDayClass(day) aspect-square flex items-center justify-center text-sm rounded transition-colors">
                @day.Date.Day
            </button>
        }
    </div>
</div>

@code {
    [Parameter] public List<DateOnly> SelectedDates { get; set; } = new();
    [Parameter] public EventCallback<List<DateOnly>> SelectedDatesChanged { get; set; }

    private DateTime CurrentMonth { get; set; } = DateTime.Now;
    private List<CalendarDay> CalendarDays { get; set; } = new();

    protected override void OnInitialized()
    {
        GenerateCalendarDays();
    }

    private void PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        GenerateCalendarDays();
    }

    private void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        GenerateCalendarDays();
    }

    private void GenerateCalendarDays()
    {
        CalendarDays.Clear();

        var firstDayOfMonth = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // Get the Monday of the week containing the first day
        var startDate = firstDayOfMonth;
        while (startDate.DayOfWeek != DayOfWeek.Monday)
        {
            startDate = startDate.AddDays(-1);
        }

        // Get the Sunday of the week containing the last day
        var endDate = lastDayOfMonth;
        while (endDate.DayOfWeek != DayOfWeek.Sunday)
        {
            endDate = endDate.AddDays(1);
        }

        // Generate all days
        var currentDate = startDate;
        while (currentDate <= endDate)
        {
            CalendarDays.Add(new CalendarDay
            {
                Date = DateOnly.FromDateTime(currentDate),
                IsCurrentMonth = currentDate.Month == CurrentMonth.Month
            });
            currentDate = currentDate.AddDays(1);
        }
    }

    private async Task ToggleDay(CalendarDay day)
    {
        if (!day.IsCurrentMonth) return;

        if (SelectedDates.Contains(day.Date))
        {
            SelectedDates.Remove(day.Date);
        }
        else
        {
            SelectedDates.Add(day.Date);
        }

        await SelectedDatesChanged.InvokeAsync(SelectedDates);
    }

    private string GetDayClass(CalendarDay day)
    {
        var baseClass = "p-2";
        
        if (!day.IsCurrentMonth)
        {
            return $"{baseClass} text-gray-300 cursor-not-allowed";
        }

        var isWeekend = day.Date.DayOfWeek == DayOfWeek.Saturday || day.Date.DayOfWeek == DayOfWeek.Sunday;
        var isSelected = SelectedDates.Contains(day.Date);
        var isToday = day.Date == DateOnly.FromDateTime(DateTime.Now);

        if (isSelected)
        {
            return $"{baseClass} bg-green-500 text-white hover:bg-green-600";
        }

        if (isToday)
        {
            return $"{baseClass} border-2 border-blue-500 hover:bg-blue-50";
        }

        if (isWeekend)
        {
            return $"{baseClass} text-gray-400 hover:bg-gray-50";
        }

        return $"{baseClass} hover:bg-gray-100";
    }

    private class CalendarDay
    {
        public DateOnly Date { get; set; }
        public bool IsCurrentMonth { get; set; }
    }
}

